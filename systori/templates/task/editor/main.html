{% extends "base.html" %}
{% load i18n l10n static dartium customformatting %}

{% block title %}{{ project.name }} > {{ job.name }}{% endblock %}
{% block head_navbar %}
  <li><a href="{% url 'project.view' project.pk %}">{{ project.name }}</a></li>
  <li class="active"><a href="{% url 'job.editor' project.pk job.pk %}">{{ job.name }}</a></li>
{% endblock %}

{% block container %}
  <style>

    #editor-area {
      max-width: 1100px;
      padding-top: 50px;
      padding-left: 50px;
      padding-bottom:100px;
      margin: auto;
    }

    sys-job,
    sys-group,
    sys-task,
    sys-lineitem,
    sys-task > div.price-difference {
      display: block;
      position: relative;
      margin-right: 15px;
    }

    sys-job,
    sys-group {
      border-right: 1px solid #e9e9e9;
    }

    sys-job > .editor,
    sys-group > .editor,
    sys-task > .editor {
      position: relative;
      padding-bottom: 10px;
      border-left: white 1px solid;
    }
    sys-lineitem > .editor {
      border-left: white 1px solid;
    }

    sys-job > .editor.changed,
    sys-group > .editor.changed,
    sys-task > .editor.changed {
      border-left-color: orange;
    }
    sys-lineitem > .editor.changed {
      border-left-color: orange;
    }

    sys-job > .editor.saving,
    sys-group > .editor.saving,
    sys-task > .editor.saving {
      border-left-color: yellow;
    }
    sys-lineitem > .editor.saving {
      border-left-color: yellow;
    }

    .editor-row {
      display: flex;
      align-items: flex-start;
    }

    /* job, group, task */

    .code {
      flex: 0 0 auto;
      font-family: monospace;
    }

    .name {
      flex: 1 1 auto;
      margin: 0 10px 0 10px;
    }

    .total {
      flex: 0 0 auto;
      position: relative;
      min-width: 90px;
      text-align: right;
      padding: 0 4px 0 4px;
      margin-right: -5px;
      margin-left: 10px;
      border: 1px solid black;
      background-color: #fff;
      z-index: 2;
    }

    .description {
      display: block;
      margin-left: 50px;
      padding-top: 20px;
      padding-bottom: 20px;
    }

    sys-group > .editor .name {
      font-weight: bold;
    }

    sys-group > .editor .total:after,
    sys-task > .editor .total:after {
      display: block;
      position: absolute;
      content: "+";

      width: 11px;
      height: 10px;

      top: 0px;
      right: -12px;

      color: #e9e9e9;
      font-size: 9px;
      text-align: left;

      padding-left: 2px;
      border-bottom: 1px solid #e9e9e9;
    }

    /* cover up end of line when last child */
    sys-group:last-child:after,
    sys-task:last-child:after {
      display: block;
      position: absolute;
      content: "";
      width: 3px;
      top: 10px;
      bottom: 0px;
      right: -17px;
      background-color: white;
    }

    /* cover up line if empty group */
    sys-group > .editor:only-child:after {
      display: block;
      position: absolute;
      content: "";
      width: 1px;
      top: 0px;
      bottom: 0px;
      right: -1px;
      background-color: white;
    }

    /* task, lineitem */

    [contenteditable]:focus {
      outline: none;
    }

    sys-task {
      padding-bottom: 20px;
    }

    .unit {
      flex: 0 0 auto;
      width: 70px;
      padding-left: 4px;
    }

    sys-lineitem > .editor .total,
    .qty, .price {
      flex: 0 0 auto;
      width: 100px;
      text-align: right;
      padding-right: 4px;
      background-color: #fff;
    }

    sys-lineitem > .editor .total {
      border: 1px solid #e9e9e9;
    }

    sys-task > .editor .price {
      position: relative;
      border: 1px solid black;
      margin-left: 10px;
    }

    sys-task > .editor .price:before {
      display: block;
      position: absolute;
      content: "x";
      width: 180px;
      height: 1px;
      padding-right: 2px;
      border-top: 1px solid #e9e9e9;
      top: -1px;
      left: -181px;
      color: #e9e9e9;
      font-size: 8px;
      text-align: right;
    }

    sys-task > .editor .price:after {
      display: block;
      position: absolute;
      content: "=";
      width: 10px;
      padding-left: 2px;
      border-top: 1px solid #e9e9e9;
      top: 1px;
      right: -11px;
      color: #e9e9e9;
      font-size: 8px;
      text-align: left;
    }

    sys-task > div.price-difference {
      display: flex;
      margin-bottom: 10px;
      margin-left: 100px;
    }

    sys-task > div.price-difference > .glyphicon {
      color: red;
    }

    sys-task > div.price-difference > .total {
      color: red;
      font-weight: bold;
      border-color: red;
      min-width: 100px;
    }

    sys-task > .editor:not(:only-child):after {
      display: block;
      position: absolute;
      content: "";
      width: 1px;
      top: 0px;
      bottom: 0px;
      right: 100px;
      border-right: 1px solid #e9e9e9;
      z-index: -1;
    }

    sys-lineitem:not(:last-child):after {
      display: block;
      position: absolute;
      content: "";
      width: 1px;
      top: 0px;
      bottom: 0px;
      right: 85px;
      border-right: 1px solid #e9e9e9;
    }

    /* line item */

    sys-lineitem {
      background-color: white;
    }

    sys-lineitem > a {
      position: absolute;
      top: -150px;
    }

    sys-lineitem,
    .sys-lineitem-placeholder {
      margin-bottom: 10px;
    }

    sys-cell[data-canonical=""] {
      font-weight: bold;
    }

    sys-cell[data-resolved] {
      font-style: italic;
    }

    sys-cell {
      position: relative;
    }

    sys-cell:focus {
      outline: none;
    }

    sys-lineitem sys-cell[data-preview]:focus:after {
      display: block;
      position: absolute;
      content: attr(data-preview);
      font-size: 10px;
      color: dimgrey;
      bottom: -10px;
      right: 4px;
      width: 400px;
    }

    .sys-lineitem-handle {
      cursor: pointer;
    }

    sys-lineitem-sheet {
      -webkit-user-select: none;
      user-select: none;
      margin-left: 100px;
      display: block;
      position: relative;
    }

    sys-lineitem-sheet:after {
      display: block;
      position: absolute;
      content: "";
      width: 1px;
      top: 0px;
      bottom: 0px;
      right: 100px;
      border-right: 1px solid #e9e9e9;
      z-index: -1;
    }

    /* description */

    sys-job > .editor .description {
      margin-right: 180px;
    }
    sys-job > sys-group > .editor .description {
      margin-right: 165px;
    }
    sys-job > sys-group > sys-group > .editor .description {
      margin-right: 150px;
    }
    sys-job > sys-group > sys-group > sys-group > .editor .description {
      margin-right: 135px;
    }
    sys-job > sys-group > sys-group > sys-group > sys-group > .editor .description {
      margin-right: 120px;
    }
    sys-task > .editor .description {
      margin-right: 105px;
    }

    /* actions */

    .actions {
      flex: 0 0 auto;
      width: 85px;
      padding-left: 20px;
    }

    .actions > span:hover {
      cursor: pointer;
    }

    .actions > span.False {
      display: none;
      color: #f0f0f0;
    }

    .editor:hover > .editor-row > .actions > span.False {
      display: inline;
    }

    /* other */

    [contenteditable][placeholder]:empty:before {
      content: attr(placeholder);
      font-style: italic;
      color: #d9d9d9;
    }

    [contenteditable][placeholder]:empty:focus:before {
      content: "";
    }


    sys-autocomplete {
      z-index: 100;
      visibility: hidden;
      position: absolute;
      background: white;
      width: 480px;
      border: 1px solid lightgrey;
      -webkit-transition: top 0.1s;
      -moz-transition: top 0.1s;
      -ms-transition: top 0.1s;
      -o-transition: top 0.1s;
      transition: top 0.1s;
    }

    sys-autocomplete > div {
      border-bottom: 1px solid lightgrey;
    }

    sys-autocomplete > div > div.name {
      font-size: 14px;
    }

    sys-autocomplete > div > p {
      font-size: 12px;
    }

    sys-autocomplete > div.active {
      background: orange;
    }

  </style>

  <div id="editor-area">

  <sys-job id="task-editor" data-pk="{{ job.pk }}" data-code="{{ job.code }}"
           data-structure-format="{{ job.project.structure.pattern}}">
    {% include "task/editor/group_editor.html" with group=job %}
    {% for group in job.groups.all %}
      {% include "task/editor/group_loop.html" with group=group %}
    {% endfor %}
    {% for task in job.tasks.all %}
      {% include "task/editor/task_loop.html" with task=task %}
    {% endfor %}
  </sys-job>

  </div>

  <template id="group-template">
    {% include "task/editor/group_editor.html" with group=blank_group %}
  </template>

  <template id="task-template">
    {% include "task/editor/task_editor.html" with task=blank_task %}
  </template>

  <template id="lineitem-template">
    {% include "task/editor/lineitem_editor.html" with lineitem=blank_lineitem %}
  </template>

{% endblock %}

{% block extra_js %}
  {% dart "job_editor.dart" %}
{% endblock extra_js %}
